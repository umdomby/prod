import { WebSocketServer, WebSocket } from 'ws';
import { IncomingMessage } from 'http';
import { getAllowedDeviceIds, getDeviceTelegramInfo } from './actions';
import { createServer } from 'http';
import axios from 'axios';

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Telegram-–±–æ—Ç–∞
let TELEGRAM_BOT_TOKEN: string | null = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Telegram-–±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
let TELEGRAM_CHAT_ID: string | null = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —á–∞—Ç–∞ Telegram, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
let lastTelegramMessageTime = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞
const TELEGRAM_MESSAGE_INTERVAL = 5000; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö) –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
const DEVICE_NAME = 'R1'; // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö Telegram

const PORT = 8096; // –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å WebSocket-—Å–µ—Ä–≤–µ—Ä
const WS_PATH = '/wsar'; // –ü—É—Ç—å –¥–ª—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "24.06.2025 13:56" —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ú–æ—Å–∫–≤—ã (UTC+3)
function formatDateTime(date: Date): string {
    const moscowOffset = 3 * 60 * 60 * 1000; // –°–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ú–æ—Å–∫–≤—ã (+3 —á–∞—Å–∞) –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    const moscowDate = new Date(date.getTime() + moscowOffset); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π –¥–∞—Ç–µ
    const day = String(moscowDate.getUTCDate()).padStart(2, '0'); // –î–µ–Ω—å –º–µ—Å—è—Ü–∞, –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤–µ–¥—É—â–∏–º –Ω—É–ª–µ–º
    const month = String(moscowDate.getUTCMonth() + 1).padStart(2, '0'); // –ú–µ—Å—è—Ü (–Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 0, –ø–æ—ç—Ç–æ–º—É +1), –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤–µ–¥—É—â–∏–º –Ω—É–ª–µ–º
    const year = moscowDate.getUTCFullYear(); // –ü–æ–ª–Ω—ã–π –≥–æ–¥
    const hours = String(moscowDate.getUTCHours()).padStart(2, '0'); // –ß–∞—Å—ã, –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤–µ–¥—É—â–∏–º –Ω—É–ª–µ–º
    const minutes = String(moscowDate.getUTCMinutes()).padStart(2, '0'); // –ú–∏–Ω—É—Ç—ã, –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤–µ–¥—É—â–∏–º –Ω—É–ª–µ–º
    return `${day}.${month}.${year} ${hours}:${minutes}`; // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
}

const server = createServer(); // –°–æ–∑–¥–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è WebSocket
const wss = new WebSocketServer({
    server, // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º WebSocket-—Å–µ—Ä–≤–µ—Ä –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É HTTP-—Å–µ—Ä–≤–µ—Ä—É
    path: WS_PATH // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –¥–ª—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
});

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö
interface ClientInfo {
    ws: WebSocket; // –û–±—ä–µ–∫—Ç WebSocket –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º
    de?: string; // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (deviceId), –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    ip: string; // IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
    isIdentified: boolean; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
    ct?: 'browser' | 'esp'; // –¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞: –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    lastActivity: number; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
    isAlive: boolean; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ping/pong)
}

const clients = new Map<number, ClientInfo>(); // –ö–∞—Ä—Ç–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö, –∫–ª—é—á ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    clients.forEach((client, clientId) => {
        if (!client.isAlive) { // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ ping, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º
            client.ws.terminate(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
            clients.delete(clientId); // –£–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–∞—Ä—Ç—ã
            console.log(`–ö–ª–∏–µ–Ω—Ç ${clientId} –æ—Ç–∫–ª—é—á–µ–Ω (–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ ping)`); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
            return;
        }
        client.isAlive = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ ping
        client.ws.ping(null, false); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    });
}, 30000); // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî 30 —Å–µ–∫—É–Ω–¥

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
wss.on('connection', async (ws: WebSocket, req: IncomingMessage) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à–µ–ª –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø—É—Ç–∏
    if (req.url !== WS_PATH) {
        ws.close(1002, '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—É—Ç—å'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—É—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π, —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏ 1002
        return;
    }

    const clientId = Date.now(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const ip = req.socket.remoteAddress || 'unknown'; // –ü–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ 'unknown', –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const client: ClientInfo = {
        ws, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç WebSocket
        ip, // –°–æ—Ö—Ä–∞–Ω—è–µ–º IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
        isIdentified: false, // –ö–ª–∏–µ–Ω—Ç –ø–æ–∫–∞ –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
        lastActivity: Date.now(), // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        isAlive: true // –ö–ª–∏–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    };
    clients.set(clientId, client); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–∞—Ä—Ç—É

    console.log(`–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${clientId} —Å IP ${ip}`); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ ping –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    ws.on('pong', () => {
        client.isAlive = true; // –ü–æ–º–µ—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ ping
        client.lastActivity = Date.now(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    ws.send(JSON.stringify({
        ty: "sys", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–∏—Å—Ç–µ–º–Ω–æ–µ
        me: "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        clientId, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
        st: "awi" // –°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    }));

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    ws.on('message', async (data: Buffer) => {
        try {
            client.lastActivity = Date.now(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
            const message = data.toString(); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±—É—Ñ–µ—Ä –≤ —Å—Ç—Ä–æ–∫—É
            console.log(`[${clientId}] –ü–æ–ª—É—á–µ–Ω–æ: ${message}`); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const parsed = JSON.parse(message); // –ü–∞—Ä—Å–∏–º JSON-—Å–æ–æ–±—â–µ–Ω–∏–µ

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–∏–ø–µ –∫–ª–∏–µ–Ω—Ç–∞
            if (parsed.ty === "clt") { // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: client_type (—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞)
                client.ct = parsed.ct; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞ (browser –∏–ª–∏ esp)
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
            if (parsed.ty === "idn") { // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: identify (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
                const allowedIds = new Set(await getAllowedDeviceIds()); // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (parsed.de && allowedIds.has(parsed.de)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ deviceId –ø–µ—Ä–µ–¥–∞–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
                    client.de = parsed.de; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    client.isIdentified = true; // –ü–æ–º–µ—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram
                    const telegramInfo = await getDeviceTelegramInfo(parsed.de); // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    TELEGRAM_BOT_TOKEN = telegramInfo?.telegramToken ?? null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω Telegram, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    TELEGRAM_CHAT_ID = telegramInfo?.telegramId?.toString() ?? null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —á–∞—Ç–∞ Telegram, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    ws.send(JSON.stringify({
                        ty: "sys", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–∏—Å—Ç–µ–º–Ω–æ–µ
                        me: "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
                        clientId, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
                        de: parsed.de, // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                        st: "con" // –°—Ç–∞—Ç—É—Å: –ø–æ–¥–∫–ª—é—á–µ–Ω
                    }));

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    if (client.ct === "esp") { // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç ‚Äî —ç—Ç–æ ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                        clients.forEach(targetClient => {
                            if (targetClient.ct === "browser" && // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä
                                targetClient.de === parsed.de && // –ò –∏–º–µ–µ—Ç —Ç–æ—Ç –∂–µ deviceId
                                targetClient.de !== null) { // –ò deviceId –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                console.log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ${targetClient.de} –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ ESP`); // –õ–æ–≥–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                                targetClient.ws.send(JSON.stringify({
                                    ty: "est", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: esp_status (—Å—Ç–∞—Ç—É—Å ESP)
                                    st: "con", // –°—Ç–∞—Ç—É—Å: –ø–æ–¥–∫–ª—é—á–µ–Ω
                                    de: parsed.de // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                    // ts: new Date().toISOString() // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
                                }));
                            }
                        });
                    }
                } else {
                    // –ï—Å–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    ws.send(JSON.stringify({
                        ty: "err", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –æ—à–∏–±–∫–∞
                        me: "–û—à–∏–±–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏", // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
                        clientId, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
                        st: "rej" // –°—Ç–∞—Ç—É—Å: –æ—Ç–∫–ª–æ–Ω–µ–Ω
                    }));
                    ws.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    return;
                }
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –∏–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É
            if (!client.isIdentified) {
                ws.send(JSON.stringify({
                    ty: "err", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –æ—à–∏–±–∫–∞
                    me: "–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω", // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
                    clientId // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
                }));
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–æ–≤ –æ—Ç ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (parsed.ty === "log" && client.ct === "esp") { // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: log, –∫–ª–∏–µ–Ω—Ç ‚Äî ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram: —Ä–µ–ª–µ 1 –≤–∫–ª—é—á–µ–Ω–æ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 1–í
                if (parsed.b1 === 'on' && parsed.z && Number(parsed.z) < 1) {
                    const now = new Date(); // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
                    const message = `üö® –î–∞—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª! –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${DEVICE_NAME}, –í—Ä–µ–º—è: ${formatDateTime(now)}`; // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
                    console.log(message); // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (TELEGRAM_BOT_TOKEN && TELEGRAM_CHAT_ID) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ ID —á–∞—Ç–∞
                        sendTelegramMessage(message); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
                    } else {
                        console.log('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è Telegram'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö Telegram
                    }
                }
                // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –ª–æ–≥–æ–≤ –æ—Ç ESP –±—Ä–∞—É–∑–µ—Ä–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
                // clients.forEach(targetClient => {
                //     if (targetClient.ct === "browser" && // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä
                //         targetClient.de === client.de) { // –ò –∏–º–µ–µ—Ç —Ç–æ—Ç –∂–µ deviceId
                //         targetClient.ws.send(JSON.stringify({
                //             ty: "log", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –ª–æ–≥
                //             me: parsed.me, // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ESP
                //             de: client.de, // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                //             // ts: new Date().toISOString(), // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
                //             or: "esp", // –ò—Å—Ç–æ—á–Ω–∏–∫: ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                //             b1: parsed.b1, // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ 1
                //             b2: parsed.b2, // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ 2
                //             sp1: parsed.sp1, // –£–≥–æ–ª –ø–µ—Ä–≤–æ–≥–æ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
                //             sp2: parsed.sp2, // –£–≥–æ–ª –≤—Ç–æ—Ä–æ–≥–æ —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞
                //             z: parsed.z // –ó–Ω–∞—á–µ–Ω–∏–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
                //         }));
                //     }
                // });
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –∫–æ–º–∞–Ω–¥ –æ—Ç ESP
            if (parsed.ty === "ack" && client.ct === "esp") { // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: acknowledge (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ), –∫–ª–∏–µ–Ω—Ç ‚Äî ESP
                clients.forEach(targetClient => {
                    if (targetClient.ct === "browser" && // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä
                        targetClient.de === client.de) { // –ò –∏–º–µ–µ—Ç —Ç–æ—Ç –∂–µ deviceId
                        targetClient.ws.send(JSON.stringify({
                            ty: "ack", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                            co: parsed.co, // –ö–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
                            de: client.de // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                            // ts: new Date().toISOString() // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
                        }));
                    }
                });
                return;
            }

            // –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –∫ ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
            if (parsed.co && parsed.de) { // –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ –∏ deviceId
                let delivered = false; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –±—ã–ª–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
                clients.forEach(targetClient => {
                    if (targetClient.de === parsed.de && // –ï—Å–ª–∏ deviceId —Å–æ–≤–ø–∞–¥–∞–µ—Ç
                        targetClient.ct === "esp" && // –¶–µ–ª–µ–≤–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî ESP
                        targetClient.isIdentified) { // –ò –∫–ª–∏–µ–Ω—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
                        targetClient.ws.send(message); // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–æ–º–∞–Ω–¥—É ESP-—É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                        delivered = true; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
                    }
                });
                // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã
                // ws.send(JSON.stringify({
                //     ty: delivered ? "cst" : "err", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: command_status (—Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥—ã) –∏–ª–∏ –æ—à–∏–±–∫–∞
                //     st: delivered ? "dvd" : "enf", // –°—Ç–∞—Ç—É—Å: delivered (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ) –∏–ª–∏ esp_not_found (ESP –Ω–µ –Ω–∞–π–¥–µ–Ω)
                //     co: parsed.co, // –ö–æ–º–∞–Ω–¥–∞
                //     de: parsed.de, // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                //     // ts: new Date().toISOString() // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
                // }));
            }

        } catch (err) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            console.error(`[${clientId}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:`, err); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            ws.send(JSON.stringify({
                ty: "err", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –æ—à–∏–±–∫–∞
                me: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è", // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
                error: (err as Error).message, // –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                clientId // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
            }));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    ws.on('close', () => {
        console.log(`–ö–ª–∏–µ–Ω—Ç ${clientId} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        if (client.ct === "esp" && client.de) { // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç ‚Äî ESP –∏ –∏–º–µ–µ—Ç deviceId
            clients.forEach(targetClient => {
                if (targetClient.ct === "browser" && // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –∫–ª–∏–µ–Ω—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä
                    targetClient.de === client.de) { // –ò –∏–º–µ–µ—Ç —Ç–æ—Ç –∂–µ deviceId
                    targetClient.ws.send(JSON.stringify({
                        ty: "est", // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: esp_status (—Å—Ç–∞—Ç—É—Å ESP)
                        st: "dis", // –°—Ç–∞—Ç—É—Å: –æ—Ç–∫–ª—é—á–µ–Ω
                        de: client.de, // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                        // ts: new Date().toISOString(), // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
                        re: "—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ" // –ü—Ä–∏—á–∏–Ω–∞: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
                    }));
                }
            });
        }
        clients.delete(clientId); // –£–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–∞—Ä—Ç—ã
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ WebSocket
    ws.on('error', (err: Error) => {
        console.error(`[${clientId}] –û—à–∏–±–∫–∞ WebSocket:`, err); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É WebSocket
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
async function sendTelegramMessage(message: string) {
    const currentTime = Date.now(); // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    if (currentTime - lastTelegramMessageTime < TELEGRAM_MESSAGE_INTERVAL) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —á–∞—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏'); // –õ–æ–≥–∏—Ä—É–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
        return;
    }
    if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ ID —á–∞—Ç–∞
        console.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–∫–µ–Ω –∏–ª–∏ ID —á–∞—Ç–∞'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        return;
    }
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ API
        const response = await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            chat_id: TELEGRAM_CHAT_ID, // ID —á–∞—Ç–∞
            text: message // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        });
        console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${message}`, response.data); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
        lastTelegramMessageTime = currentTime; // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    } catch (error: any) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram:', error.response?.data || error.message); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
server.listen(PORT, () => {
    console.log(`WebSocket-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ ws://0.0.0.0:${PORT}${WS_PATH}`); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
});